#!/usr/bin/env bash
. "$(dirname "$0")/_/husky.sh"

# Prevent accidental commit of .env.production
bash scripts/prevent-env-commit.sh

# Allow CI/operators to bypass hooks by setting SKIP_HOOKS=1
if [ "${SKIP_HOOKS:-0}" = "1" ] || [ "${HUSKY_SKIP_HOOKS:-0}" = "1" ]; then
  echo "SKIP_HOOKS set; skipping pre-commit checks";
  exit 0;
fi

echo "Running lightweight local pre-commit checks (CI will run full pipeline)..."

# Run only the quick ESLint rule tests (fast)
echo "Running ESLint custom rule tests..."
npm run test:eslint-rules || { echo "Custom ESLint rule tests failed" && exit 1; }

# Run lint-staged to lint/fix staged files
echo "Running lint-staged for staged files..."
npx --no-install lint-staged || { echo "lint-staged failed" && exit 1; }

# Run lightweight related unit tests for staged files (don't run full suite locally)
if [ -x "./scripts/precommit-local-tests.sh" ]; then
  echo "Running local related tests for staged files..."
  bash ./scripts/precommit-local-tests.sh || { echo "related tests failed" && exit 1; }
else
  echo "Local pre-commit helper not found; skipping related tests."
fi

echo "Local pre-commit checks completed. Full checks run on CI." 