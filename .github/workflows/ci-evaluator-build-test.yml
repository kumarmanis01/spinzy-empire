name: CI - Evaluator Build & Dry-run Integration

on:
  pull_request:
  workflow_dispatch:
    inputs:
      evaluator_dry_run:
        description: 'Set to 1 to run in dry-run mode, 0 to perform real sinks'
        required: false
        default: '1'
      run_once:
        description: 'Set to 1 to run evaluator once then exit'
        required: false
        default: '1'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      HUSKY: '0'
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: pass
          POSTGRES_DB: ai_tutor_test
        ports:
          - 5432
        options: >-
          --health-cmd "pg_isready -U test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Node modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.cache
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci

      - name: Set up Helm
        uses: azure/setup-helm@v3

      - name: Helm lint chart
        run: helm lint deployment/helm/evaluator-chart

      - name: Generate Prisma client
        env:
          DATABASE_URL: postgres://test:pass@127.0.0.1:${{ job.services.postgres.ports[5432] }}/ai_tutor_test
        run: npx prisma generate

      - name: Apply migrations
        env:
          DATABASE_URL: postgres://test:pass@127.0.0.1:${{ job.services.postgres.ports[5432] }}/ai_tutor_test
        run: npx prisma migrate deploy --preview-feature

      - name: Bundle evaluator (esbuild - CommonJS)
        run: npx esbuild scripts/runAlertEvaluator.ts --bundle --platform=node --target=node20 --format=cjs --outfile=build/runAlertEvaluator.cjs --external:@prisma/client --external:prom-client --external:ioredis --sourcemap

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: evaluator-bundle
          path: build/runAlertEvaluator.cjs

      - name: Run evaluator integration
        env:
          # Prefer an explicit secret DATABASE_URL if provided; otherwise use the service
          DATABASE_URL: ${{ secrets.DATABASE_URL || format('postgres://test:pass@127.0.0.1:{0}/ai_tutor_test', job.services.postgres.ports[5432]) }}
          # Allow manual override from workflow_dispatch inputs; default to dry-run for PRs
          EVALUATOR_DRY_RUN: ${{ github.event.inputs.evaluator_dry_run || '1' }}
          RUN_ONCE: ${{ github.event.inputs.run_once || '1' }}
          # Optional secrets used for real sinks (set in repository secrets for staging):
          OPS_EMAIL: ${{ secrets.OPS_EMAIL || '' }}
          SMTP_HOST: ${{ secrets.SMTP_HOST || '' }}
          SMTP_PORT: ${{ secrets.SMTP_PORT || '' }}
          SMTP_USER: ${{ secrets.SMTP_USER || '' }}
          SMTP_PASS: ${{ secrets.SMTP_PASS || '' }}
          REDIS_URL: ${{ secrets.REDIS_URL || '' }}
          # Optional Pushgateway URL from secrets if set
          PUSHGATEWAY_URL: ${{ secrets.PUSHGATEWAY_URL || '' }}
        run: |
          node build/runAlertEvaluator.cjs
